name: SageMaker Training Pipeline

on:
  #push:
  #  branches: [ main, develop ]
  #pull_request:
  #  branches: [ main ]
  workflow_dispatch:  # Allow manual triggering
    inputs:
      instance_type:
        description: 'SageMaker training instance type'
        required: false
        default: 'ml.m5.large'
        type: choice
        options:
        - ml.m5.large
        - ml.m5.xlarge
        - ml.p3.2xlarge
        - ml.g4dn.xlarge
      epochs:
        description: 'Number of training epochs'
        required: false
        default: '0.0001'
        type: string
      use_spot:
        description: 'Use spot instances'
        required: false
        default: true
        type: boolean

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: bert/training
  S3_BUCKET: ${{ secrets.S3_BUCKET_NAME }}

jobs:
  build-and-train:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
      with:
        registry-type: public

    - name: Get commit hash
      id: get-commit-hash
      run: echo "commit_hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      
    - name: Build, tag, and push image to Amazon ECR
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        REGISTRY_ALIAS: z7k4k3d4
        IMAGE_TAG: ${{ steps.get-commit-hash.outputs.commit_hash }}
      run: |
        # Create ECR repository if it doesn't exist
        aws ecr-public describe-repositories --repository-names $ECR_REPOSITORY
        echo "image_uri=$ECR_REGISTRY/$ECR_REPOSITORY:5d8f0a4" >> $GITHUB_ENV
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install boto3 sagemaker
        
    - name: Launch SageMaker training job
      env:
        IMAGE_URI: ${{ env.image_uri }}
        SAGEMAKER_ROLE: ${{ secrets.SAGEMAKER_EXECUTION_ROLE }}
        INSTANCE_TYPE: ${{ github.event.inputs.instance_type || 'ml.m5.large' }}
        EPOCHS: ${{ github.event.inputs.epochs || '0.0001' }}
        USE_SPOT: ${{ github.event.inputs.use_spot || 'true' }}
      run: |
        python .github/scripts/launch_training.py
        